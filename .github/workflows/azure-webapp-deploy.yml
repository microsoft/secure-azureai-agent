name: Azure App Service - Deploy to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  # ============================================
  # ðŸ”§ ãƒãƒ³ã‚ºã‚ªãƒ³è¨­å®š: ä»¥ä¸‹ã‚’å€‹äººã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„
  # ============================================
  
  # æ—¢å­˜Azureãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®š (az resource list ã§ç¢ºèªå¯èƒ½)
  AZURE_WEBAPP_BACKEND_NAME: 'redteaming-demo-back-swe-mkurahara'   # ðŸ”§ å¤‰æ›´å¿…è¦: ã‚ãªãŸã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰App Serviceå
  AZURE_WEBAPP_FRONTEND_NAME: 'redteaming-demo-front-swe-mkurahara' # ðŸ”§ å¤‰æ›´å¿…è¦: ã‚ãªãŸã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰App Serviceå
  AZURE_RESOURCE_GROUP: 'redteaming-demo-rg-swe-mkurahara'          # ðŸ”§ å¤‰æ›´å¿…è¦: ã‚ãªãŸã®Resource Groupå
  
  # ãã®ä»–ã®è¨­å®š
  PYTHON_VERSION: '3.11'                                           # Chainlitã¨ã®äº’æ›æ€§ã®ãŸã‚3.11ã‚’ä½¿ç”¨

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install backend dependencies (optimized)
      run: |
        cd backend
        python -m pip install --upgrade pip
        # æœ€é©åŒ–ã•ã‚ŒãŸrequirementsã‚’ä½¿ç”¨
        if [ -f requirements-optimized.txt ]; then
          echo "Using optimized requirements..."
          pip install -r requirements-optimized.txt --no-cache-dir
        else
          echo "Using standard requirements..."
          pip install -r requirements.txt --no-cache-dir
        fi

    - name: Install frontend dependencies (optimized)
      run: |
        cd frontend
        python -m pip install --upgrade pip
        # æœ€é©åŒ–ã•ã‚ŒãŸrequirementsã‚’ä½¿ç”¨
        if [ -f requirements-optimized.txt ]; then
          echo "Using optimized requirements..."
          pip install -r requirements-optimized.txt --no-cache-dir
        else
          echo "Using standard requirements..."
          pip install -r requirements.txt --no-cache-dir
        fi

    - name: Run backend tests
      run: |
        cd backend
        # Add test commands here when tests are available
        # python -m pytest tests/

    - name: Package backend (zip - prebuilt)
      run: |
        echo "Creating prebuilt backend package..."
        rm -rf deploy-package backend-package.zip
        mkdir -p deploy-package
        
        # Copy source code
        echo "Copying source files..."
        cp -r backend/src deploy-package/
        
        # Pre-install dependencies to site-packages directory
        echo "Pre-installing dependencies..."
        pip install -r backend/requirements.txt \
          --target deploy-package/site-packages \
          --no-cache-dir
        # --no-deps ã‚’å‰Šé™¤ã—ã¦ã€ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

        # Create optimized startup script (no installation needed)
        cat > deploy-package/startup.sh << 'EOF'
        #!/bin/bash
        cd /home/site/wwwroot
        export PYTHONPATH="/home/site/wwwroot:/home/site/wwwroot/site-packages"
        echo "Starting application directly (no install needed)..."
        python -m gunicorn --bind 0.0.0.0:${PORT:-8000} src.main:app -k uvicorn.workers.UvicornWorker --timeout 120 --workers 1
        EOF
        chmod +x deploy-package/startup.sh
        
        # Create ZIP package
        cd deploy-package
        zip -r ../backend-package.zip .
        cd ..
        rm -rf deploy-package
        
        echo "Package created successfully:"
        ls -lh backend-package.zip
        echo "Package contents:"
        unzip -l backend-package.zip | head -20

    - name: Package frontend (zip)
      run: |
        # App Serviceã®ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ãŒæœŸå¾…ã™ã‚‹æ§‹é€ ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
        mkdir -p deploy-package/frontend
        cp -r frontend/* deploy-package/frontend/
        # æœ€é©åŒ–ã•ã‚ŒãŸrequirementsã‚’ä½¿ç”¨
        if [ -f frontend/requirements-optimized.txt ]; then
          echo "Using optimized requirements for frontend deployment..."
          cp frontend/requirements-optimized.txt deploy-package/requirements.txt
        else
          echo "Using standard requirements for frontend deployment..."
          cp frontend/requirements.txt deploy-package/
        fi
        cd deploy-package
        zip -r ../frontend-package.zip . \
          -x "*.git*" "*__pycache__*" "*.pyc" "*.pyo" "*.pyd" \
          ".env" "*.pytest_cache*" "*.DS_Store"
        cd ..
        rm -rf deploy-package
        ls -lh frontend-package.zip

    - name: Upload backend artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-app
        path: backend-package.zip

    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-app
        path: frontend-package.zip

  # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
  # deploy-infrastructure:
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   needs: build-and-test
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #
  #   - name: Azure Login
  #     uses: azure/login@v1
  #     with:
  #       creds: ${{ secrets.AZURE_CREDENTIALS }}
  #
  #   - name: Setup Azure CLI
  #     uses: azure/CLI@v1
  #     with:
  #       azcliversion: latest
  #
  #   - name: Install Azure Developer CLI
  #     run: |
  #       curl -fsSL https://aka.ms/install-azd.sh | bash
  #
  #   - name: Deploy infrastructure with azd
  #     run: |
  #       azd auth login --client-id ${{ secrets.AZURE_CLIENT_ID }} --client-secret ${{ secrets.AZURE_CLIENT_SECRET }} --tenant-id ${{ secrets.AZURE_TENANT_ID }}
  #       azd env new production --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} --location "East US"
  #       azd provision --no-prompt
  #     env:
  #       AZURE_ENV_NAME: production
  #       AZURE_LOCATION: eastus
  #       AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  deploy-backend:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-app
        path: ./

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Pre-deployment cleanup and health check
      run: |
        echo "Checking for ongoing deployments..."
        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªï¼ˆæœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ï¼‰
        LATEST_DEPLOYMENT=$(az webapp log deployment list \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "[0].{status:status, id:id}" -o json 2>/dev/null || echo "{}")
        
        if [ ! -z "$LATEST_DEPLOYMENT" ] && [ "$LATEST_DEPLOYMENT" != "{}" ]; then
          STATUS=$(echo $LATEST_DEPLOYMENT | jq -r '.status // "Unknown"' 2>/dev/null || echo "Unknown")
          echo "Latest deployment status: $STATUS"
          
          if [[ "$STATUS" == "Building" || "$STATUS" == "InProgress" || "$STATUS" == "Deploying" ]]; then
            echo "Found ongoing deployment, waiting..."
            sleep 60
          fi
        else
          echo "No deployment history found or unable to check status"
        fi
        
        echo "Removing WEBSITE_RUN_FROM_PACKAGE setting to allow deployment..."
        az webapp config appsettings delete \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --setting-names WEBSITE_RUN_FROM_PACKAGE || true
        
        echo "Stopping the app service to ensure clean state..."
        az webapp stop \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        
        sleep 10

    - name: Backend Deploy (no-build mode)
      run: |
        set -euo pipefail
        
        # App Service ã®èµ·å‹•
        echo "Starting App Service..."
        az webapp start \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        
        sleep 15
        
        # ãƒ“ãƒ«ãƒ‰ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–ï¼ˆäº‹å‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½¿ç”¨ï¼‰
        echo "Configuring for prebuilt package deployment (no build needed)..."
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            SCM_DO_BUILD_DURING_DEPLOYMENT=false \
            WEBSITE_RUN_FROM_PACKAGE=1 \
            ENABLE_ORYX_BUILD=false \
            PYTHONPATH="/home/site/wwwroot:/home/site/wwwroot/site-packages" \
            PORT=8000
            
        # ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒžãƒ³ãƒ‰è¨­å®š
        echo "Setting startup command..."
        az webapp config set \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --startup-file 'startup.sh'
        
        # é«˜é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰
        echo "Deploying prebuilt package..."
        az webapp deploy \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --src-path "backend-package.zip" \
          --type zip \
          --restart true \
          --timeout 300
        
        echo "Deployment completed. Waiting for app to start..."
        sleep 30

    - name: Verify Backend Deployment
      run: |
        echo "Checking deployment logs..."
        az webapp log deployment show \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --deployment-id latest 2>/dev/null || echo "No deployment logs available"

        echo "Checking app health..."
        sleep 10
        HEALTH_URL="https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net/health"
        HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
        echo "HTTP response code: $HTTP_CODE"
        if [ "$HTTP_CODE" == "200" ]; then
          echo "âœ… Backend health check passed!"
        elif [ "$HTTP_CODE" == "404" ]; then
          echo "âš ï¸ Backend is running but health endpoint not found"
        else
          echo "âŒ Backend health check failed with code: $HTTP_CODE"
        fi

        echo "Showing recent logs (last 50 lines)..."
        az webapp log tail \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --lines 50 2>/dev/null || echo "Unable to fetch application logs"

    - name: Set Backend Environment Variables
      run: |
        # ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰è¨­å®šã¯ç„¡åŠ¹ã®ã¾ã¾ç¶­æŒï¼‰
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            PORT=8000 \
            PYTHONPATH="/home/site/wwwroot:/home/site/wwwroot/site-packages" \
            PYTHONUNBUFFERED=1 \
            ENVIRONMENT=production \
            WEBSITE_PYTHON_VERSION=3.11 \
            SCM_DO_BUILD_DURING_DEPLOYMENT=false \
            ENABLE_ORYX_BUILD=false \
            WEBSITE_RUN_FROM_PACKAGE=1 \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
            WEBSITE_HTTPLOGGING_RETENTION_DAYS=1 \
            WEBSITE_TIME_ZONE="UTC"
        
        az webapp config set \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --linux-fx-version "PYTHON|3.11"

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-backend]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-app
        path: ./

    - name: Unzip frontend artifact
      run: |
        rm -rf frontend || true
        unzip -q frontend-package.zip -d frontend
        ls -R1 frontend | head -50

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Backend URL
      id: backend-url
      run: |
        BACKEND_URL=$(az webapp show --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query defaultHostName -o tsv)
        echo "BACKEND_URL=https://$BACKEND_URL" >> $GITHUB_OUTPUT

    - name: Deploy to Azure App Service (Frontend)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_FRONTEND_NAME }}
        package: frontend-package.zip
        clean: true
        startup-command: 'cd frontend && chainlit run app.py --host 0.0.0.0 --port ${PORT:-8000}'

    - name: Retry on Conflict (Frontend)
      if: failure()
      run: |
        echo "Primary deployment failed, trying alternative approach..."
        
        # WEBSITE_RUN_FROM_PACKAGEã‚’å‰Šé™¤
        az webapp config.appsettings.delete \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --setting-names WEBSITE_RUN_FROM_PACKAGE || true
        
        # az webapp deployã‚’ä½¿ç”¨
        az webapp deploy \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --src-path "frontend-package.zip" \
          --type zip \
          --restart true \
          --clean true \
          --timeout 600

    - name: Set Frontend Environment Variables
      run: |
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            BACKEND_API_URL="${{ steps.backend-url.outputs.BACKEND_URL }}" \
            PORT=8000 \
            PYTHONPATH=/home/site/wwwroot/frontend \
            PYTHONUNBUFFERED=1 \
            WEBSITE_PYTHON_VERSION=3.11 \
            SCM_DO_BUILD_DURING_DEPLOYMENT=true \
            ENABLE_ORYX_BUILD=true \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false
        
        az webapp config set \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --linux-fx-version "PYTHON|3.11" \
          --web-sockets-enabled true
