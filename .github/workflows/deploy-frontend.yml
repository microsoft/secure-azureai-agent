name: Deploy Frontend to Azure

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_run:
    workflows: ["Deploy Backend to Azure"]
    types:
      - completed

env:
  # ============================================
  # ðŸ”§ ãƒãƒ³ã‚ºã‚ªãƒ³è¨­å®š: ä»¥ä¸‹ã‚’å€‹äººã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„
  # ============================================
  
  # æ—¢å­˜Azureãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®š (az resource list ã§ç¢ºèªå¯èƒ½)
  AZURE_WEBAPP_FRONTEND_NAME: 'redteaming-demo-front-swe-mkurahara' # ðŸ”§ å¤‰æ›´å¿…è¦: ã‚ãªãŸã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰App Serviceå
  AZURE_WEBAPP_BACKEND_NAME: 'redteaming-demo-back-swe-mkurahara'   # ðŸ”§ å¤‰æ›´å¿…è¦: ã‚ãªãŸã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰App Serviceå
  AZURE_RESOURCE_GROUP: 'redteaming-demo-rg-swe-mkurahara'          # ðŸ”§ å¤‰æ›´å¿…è¦: ã‚ãªãŸã®Resource Groupå
  
  # ãã®ä»–ã®è¨­å®š
  PYTHON_VERSION: '3.11'                                           # Chainlitã¨ã®äº’æ›æ€§ã®ãŸã‚3.11ã‚’ä½¿ç”¨

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install frontend dependencies (optimized)
      run: |
        cd frontend
        python -m pip install --upgrade pip
        # æœ€é©åŒ–ã•ã‚ŒãŸrequirementsã‚’ä½¿ç”¨
        if [ -f requirements-optimized.txt ]; then
          echo "Using optimized requirements..."
          pip install -r requirements-optimized.txt --no-cache-dir
        else
          echo "Using standard requirements..."
          pip install -r requirements.txt --no-cache-dir
        fi

    - name: Package frontend (zip)
      run: |
        # App Serviceã®ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ãŒæœŸå¾…ã™ã‚‹æ§‹é€ ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
        mkdir -p deploy-package/frontend
        cp -r frontend/* deploy-package/frontend/
        # æœ€é©åŒ–ã•ã‚ŒãŸrequirementsã‚’ä½¿ç”¨
        if [ -f frontend/requirements-optimized.txt ]; then
          echo "Using optimized requirements for frontend deployment..."
          cp frontend/requirements-optimized.txt deploy-package/requirements.txt
        else
          echo "Using standard requirements for frontend deployment..."
          cp frontend/requirements.txt deploy-package/
        fi
        cd deploy-package
        zip -r ../frontend-package.zip . \
          -x "*.git*" "*__pycache__*" "*.pyc" "*.pyo" "*.pyd" \
          ".env" "*.pytest_cache*" "*.DS_Store"
        cd ..
        rm -rf deploy-package
        ls -lh frontend-package.zip

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Backend URL
      id: backend-url
      run: |
        BACKEND_URL=$(az webapp show \
          --name ${{ env.AZURE_WEBAPP_BACKEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query defaultHostName -o tsv)
        echo "BACKEND_URL=https://$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "Backend URL: https://$BACKEND_URL"

    - name: Pre-deployment cleanup (Frontend)
      run: |
        echo "Preparing frontend deployment..."
        
        # WEBSITE_RUN_FROM_PACKAGEã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¨±å¯
        az webapp config appsettings delete \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --setting-names WEBSITE_RUN_FROM_PACKAGE || true
        
        # App Serviceã‚’ä¸€åº¦åœæ­¢ã—ã¦çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        echo "Stopping frontend app service..."
        az webapp stop \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        
        sleep 10
        
        # App Serviceã‚’èµ·å‹•
        echo "Starting frontend app service..."
        az webapp start \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        
        sleep 15

    - name: Deploy Frontend (with extended timeout)
      run: |
        set -euo pipefail
        
        # ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«è¨­å®šï¼‰
        echo "Setting environment variables..."
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            BACKEND_API_URL="${{ steps.backend-url.outputs.BACKEND_URL }}" \
            PORT=8000 \
            PYTHONPATH=/home/site/wwwroot/frontend \
            PYTHONUNBUFFERED=1 \
            WEBSITE_PYTHON_VERSION=3.11 \
            SCM_DO_BUILD_DURING_DEPLOYMENT=true \
            ENABLE_ORYX_BUILD=true \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false
        
        # ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒžãƒ³ãƒ‰ã®è¨­å®š
        echo "Setting startup command..."
        az webapp config set \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --startup-file 'cd frontend && chainlit run app.py --host 0.0.0.0 --port ${PORT:-8000}' \
          --linux-fx-version "PYTHON|3.11" \
          --web-sockets-enabled true
        
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆå¤§å¹…ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ï¼‰
        echo "Deploying frontend package..."
        az webapp deploy \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --src-path "frontend-package.zip" \
          --type zip \
          --restart true \
          --timeout 1200 || {
            echo "âš ï¸ Frontend deployment command timed out, but deployment may still be in progress..."
            echo "Checking deployment status in 30 seconds..."
            sleep 30
            
            # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
            DEPLOYMENT_STATUS=""
            for i in {1..15}; do
              echo "Checking frontend deployment status (attempt $i)..."
              DEPLOYMENT_STATUS=$(az webapp log deployment list \
                --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --query "[0].status" -o tsv 2>/dev/null || echo "Unknown")
              
              echo "Frontend deployment status: $DEPLOYMENT_STATUS"
              
              if [[ "$DEPLOYMENT_STATUS" == "Success" ]]; then
                echo "âœ… Frontend deployment completed successfully!"
                break
              elif [[ "$DEPLOYMENT_STATUS" == "Failed" ]]; then
                echo "âŒ Frontend deployment failed!"
                echo "Trying alternative deployment method..."
                
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Azure Web Apps Deploy ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
                echo "Attempting deployment with alternative method..."
                az webapp deploy \
                  --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                  --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
                  --src-path "frontend-package.zip" \
                  --type zip \
                  --restart true \
                  --clean true \
                  --timeout 600 || echo "Alternative deployment also timed out"
                break
              else
                echo "Frontend deployment still in progress, waiting..."
                sleep 40
              fi
            done
          }
        
        echo "Frontend deployment phase completed. Waiting for app to start..."
        sleep 90

    - name: Verify Frontend Deployment
      run: |
        echo "Checking frontend deployment logs..."
        az webapp log deployment show \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --deployment-id latest 2>/dev/null || echo "No frontend deployment logs available"

        echo "Checking frontend app health with extended retry..."
        FRONTEND_URL="https://${{ env.AZURE_WEBAPP_FRONTEND_NAME }}.azurewebsites.net"
        
        # æœ€å¤§12å›žã€å„45ç§’é–“éš”ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯èµ·å‹•ã«æ™‚é–“ãŒã‹ã‹ã‚‹ï¼‰
        for i in {1..12}; do
          echo "Frontend health check attempt $i/12..."
          HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" --max-time 45 $FRONTEND_URL || echo "000")
          echo "HTTP response code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "âœ… Frontend health check passed!"
            break
          elif [[ "$HTTP_CODE" =~ ^[23] ]]; then
            echo "âœ… Frontend is responding (HTTP $HTTP_CODE)!"
            break
          else
            echo "âŒ Frontend health check failed with code: $HTTP_CODE"
            if [ $i -lt 12 ]; then
              echo "Waiting 45 seconds before retry..."
              sleep 45
            fi
          fi
        done

        echo "Showing recent frontend logs (last 100 lines)..."
        az webapp log tail \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --lines 100 2>/dev/null || echo "Unable to fetch frontend application logs"

    - name: Frontend Status Summary
      if: always()
      run: |
        echo "=== Frontend Deployment Summary ==="
        az webapp show \
          --name ${{ env.AZURE_WEBAPP_FRONTEND_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "{name:name, status:state, url:defaultHostName, location:location}" -o table
        
        echo ""
        echo "Frontend URL: https://${{ env.AZURE_WEBAPP_FRONTEND_NAME }}.azurewebsites.net"
        echo "Backend API URL: ${{ steps.backend-url.outputs.BACKEND_URL }}"
        
        echo ""
        echo "=== Deployment Complete ==="
        echo "You can now access the application at the frontend URL above."